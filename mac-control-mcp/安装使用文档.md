# Mac Control MCP Server - 安装和使用文档

一个基于 Model Context Protocol (MCP) 的服务器，允许 Claude Desktop 通过 AppleScript 和 Shell 命令控制 macOS 电脑。

## 目录

- [功能特性](#功能特性)
- [系统要求](#系统要求)
- [安装步骤](#安装步骤)
- [配置 Claude Desktop](#配置-claude-desktop)
- [授予系统权限](#授予系统权限)
- [使用示例](#使用示例)
- [所有可用工具](#所有可用工具)
- [常见问题解决](#常见问题解决)
- [开发指南](#开发指南)

---

## 功能特性

### 系统控制
- 设置和获取系统音量
- 静音/取消静音音频
- 设置和获取显示器亮度
- 获取电池状态
- 获取系统信息（CPU、内存、磁盘、macOS 版本）

### 应用程序管理
- 打开/启动应用程序
- 关闭/退出应用程序（支持强制退出选项）
- 列出正在运行的应用程序
- 激活/切换到应用程序
- 隐藏应用程序
- 检查应用程序是否正在运行

### 文件操作
- 用默认或指定应用程序打开文件
- 在 Finder 中打开文件夹
- 在 Finder 中显示文件/文件夹
- 使用 Spotlight 搜索文件
- 获取文件/文件夹信息
- 将文件/文件夹移到废纸篓

---

## 系统要求

- **macOS**: 10.15 (Catalina) 或更高版本
- **Node.js**: v20 或更高版本
- **Claude Desktop**: 最新版本

---

## 安装步骤

### 1. 克隆或下载项目

```bash
# 如果使用 Git
git clone <仓库地址>
cd mac-control-mcp

# 或者直接下载并解压到某个目录
cd /path/to/mac-control-mcp
```

### 2. 安装依赖

```bash
npm install
```

这将自动安装所有必需的依赖包，包括：
- `@modelcontextprotocol/sdk` - MCP SDK
- `@types/node` - Node.js 类型定义
- `typescript` - TypeScript 编译器

### 3. 编译项目

```bash
npm run build
```

编译成功后，会在 `build/` 目录下生成 JavaScript 文件。

### 4. 验证安装

检查编译输出是否存在：

```bash
ls build/index.js
```

如果看到文件路径，说明编译成功！

---

## 配置 Claude Desktop

### 1. 获取项目的绝对路径

```bash
cd /path/to/mac-control-mcp
pwd
```

复制输出的路径，例如：`/Users/yourname/Desktop/md/mac-control-mcp`

### 2. 打开 Claude Desktop 配置文件

```bash
# 使用 VSCode 打开（推荐）
code ~/Library/Application\ Support/Claude/claude_desktop_config.json

# 或使用其他编辑器
open -a TextEdit ~/Library/Application\ Support/Claude/claude_desktop_config.json
```

如果文件不存在，创建一个新文件。

### 3. 添加 MCP 服务器配置

在配置文件中添加以下内容（**注意替换路径为你的实际路径**）：

```json
{
  "mcpServers": {
    "mac-control": {
      "command": "node",
      "args": ["/Users/yourname/Desktop/md/mac-control-mcp/build/index.js"]
    }
  }
}
```

**重要提示：**
- 路径必须是**绝对路径**（以 `/` 开头）
- 不要使用 `~` 或相对路径
- 确保路径中的 `build/index.js` 文件存在

如果你已经有其他 MCP 服务器，配置应该类似这样：

```json
{
  "mcpServers": {
    "其他服务器": {
      "command": "...",
      "args": ["..."]
    },
    "mac-control": {
      "command": "node",
      "args": ["/Users/yourname/Desktop/md/mac-control-mcp/build/index.js"]
    }
  }
}
```

### 4. 重启 Claude Desktop

**完全退出并重启 Claude Desktop**（不是最小化窗口）：

```bash
# 方法 1：使用快捷键
# 按 Cmd+Q 退出 Claude Desktop

# 方法 2：使用命令行
osascript -e 'quit app "Claude"'

# 然后重新打开
open -a Claude
```

---

## 授予系统权限

macOS 需要以下权限才能让 MCP 服务器正常工作：

### 必需权限

#### 1. 辅助功能 (Accessibility)

**为什么需要：** 控制应用程序和系统设置

**如何授予：**
1. 打开 **系统设置**
2. 前往 **隐私与安全性** > **辅助功能**
3. 点击锁图标解锁（需要输入密码）
4. 点击 **"+"** 按钮
5. 找到并添加 **"Claude"**（如果找不到，添加 **"node"**）
6. 确保复选框已勾选

#### 2. 自动化 (Automation)

**为什么需要：** 通过 AppleScript 控制其他应用程序

**如何授予：**
1. 打开 **系统设置**
2. 前往 **隐私与安全性** > **自动化**
3. 找到 **"Claude"** 或 **"node"**
4. 勾选允许控制的应用，例如：
   - 系统事件 (System Events)
   - 访达 (Finder)
   - Safari、Chrome 等你想控制的应用

### 可选权限

#### 3. 完全磁盘访问权限 (Full Disk Access)

**何时需要：** 如果需要访问受保护的文件和文件夹

**如何授予：**
1. 打开 **系统设置**
2. 前往 **隐私与安全性** > **完全磁盘访问权限**
3. 添加 **"Claude"** 或 **"node"**

**注意：** 授予权限后，建议重启 Claude Desktop 使权限生效。

---

## 使用示例

配置完成后，在 Claude Desktop 中就可以用自然语言控制你的 Mac 了！

### 系统控制示例

```
你：把音量设置为 50
你：当前音量是多少？
你：静音
你：取消静音
你：把屏幕亮度设置为 80
你：显示电池状态
你：获取系统信息
```

### 应用程序管理示例

```
你：打开 Safari
你：打开 Google Chrome
你：关闭 Safari
你：列出所有正在运行的应用
你：切换到 Visual Studio Code
你：隐藏 Slack
你：Chrome 在运行吗？
```

**重要提示：** 使用应用程序的**完整名称**，例如：
- 使用 "Google Chrome" 而不是 "Chrome"
- 使用 "Visual Studio Code" 而不是 "VSCode"
- 使用 "Microsoft Word" 而不是 "Word"

### 文件操作示例

```
你：打开 ~/Documents/report.pdf
你：打开我的下载文件夹
你：在 Finder 中显示 ~/Desktop/image.png
你：搜索包含 'budget' 的文件
你：显示 ~/Documents/notes.txt 的信息
你：把 ~/Desktop/old-file.txt 移到废纸篓
```

**路径提示：**
- 使用绝对路径或 `~` 表示用户主目录
- 例如：`~/Desktop` = `/Users/yourname/Desktop`

---

## 所有可用工具

MCP 服务器提供了 **19 个工具**，分为 3 大类：

### 系统控制工具（7 个）

| 工具名称 | 功能描述 | 示例 |
|---------|---------|------|
| `set_volume` | 设置系统音量（0-100） | "设置音量为 50" |
| `get_volume` | 获取当前音量 | "当前音量是多少？" |
| `mute` | 静音/取消静音音频 | "静音" |
| `set_brightness` | 设置显示器亮度（0-100） | "把亮度设置为 75" |
| `get_brightness` | 获取当前亮度 | "当前亮度是多少？" |
| `get_battery_status` | 获取电池信息 | "显示电池状态" |
| `get_system_info` | 获取系统详细信息 | "获取系统信息" |

### 应用程序管理工具（6 个）

| 工具名称 | 功能描述 | 示例 |
|---------|---------|------|
| `open_app` | 启动应用程序 | "打开 Safari" |
| `close_app` | 退出应用程序 | "关闭 Safari" |
| `list_running_apps` | 列出正在运行的应用 | "列出所有应用" |
| `activate_app` | 切换到应用程序 | "切换到 Chrome" |
| `hide_app` | 隐藏应用程序 | "隐藏 Slack" |
| `is_app_running` | 检查应用是否运行 | "Safari 在运行吗？" |

### 文件操作工具（6 个）

| 工具名称 | 功能描述 | 示例 |
|---------|---------|------|
| `open_file` | 打开文件 | "打开 ~/Desktop/doc.pdf" |
| `open_folder` | 在 Finder 中打开文件夹 | "打开下载文件夹" |
| `reveal_in_finder` | 在 Finder 中显示项目 | "在 Finder 中显示 ~/Desktop/photo.jpg" |
| `spotlight_search` | 使用 Spotlight 搜索文件 | "搜索包含 'meeting' 的文件" |
| `get_file_info` | 获取文件/文件夹详细信息 | "显示 ~/Documents 的信息" |
| `move_to_trash` | 将项目移到废纸篓 | "把 ~/Desktop/old.txt 移到废纸篓" |

---

## 常见问题解决

### 问题 1: MCP 服务器未出现在 Claude Desktop 中

**症状：** Claude Desktop 无法识别工具

**解决方案：**
1. 检查 `claude_desktop_config.json` 中的路径是否为绝对路径且正确
2. 验证构建是否成功：
   ```bash
   npm run build
   ```
3. 检查构建输出是否存在：
   ```bash
   ls build/index.js
   ```
4. **完全重启** Claude Desktop（Cmd+Q 然后重新打开）
5. 查看 Claude Desktop 日志中的错误信息

### 问题 2: 权限拒绝错误

**症状：** 操作失败，提示权限被拒绝

**解决方案：**
1. 前往 **系统设置** > **隐私与安全性**
2. 将 Claude Desktop 或 node 添加到 **辅助功能** 和 **自动化**
3. 确保复选框已勾选
4. 重启 Claude Desktop

### 问题 3: 找不到应用程序

**症状：** 提示 "无法打开应用程序" 错误

**解决方案：**
- 使用应用程序在 Applications 文件夹中显示的**完整名称**
- 正确示例：
  - ✅ "Google Chrome"
  - ✅ "Visual Studio Code"
  - ✅ "Microsoft Word"
- 错误示例：
  - ❌ "Chrome"
  - ❌ "VSCode"
  - ❌ "Word"
- 可以先使用 `list_running_apps` 查看正确的名称

### 问题 4: 文件未找到

**症状：** 打开文件时提示 "文件未找到"

**解决方案：**
- 使用绝对路径或以 `~` 开头的路径
- 检查文件是否存在：
  ```bash
  ls -la /path/to/file
  ```
- 确保文件具有适当的权限

### 问题 5: 配置文件格式错误

**症状：** Claude Desktop 启动失败或显示配置错误

**解决方案：**
- 确保 JSON 格式正确（没有多余的逗号、引号匹配）
- 使用 JSON 验证工具检查：
  ```bash
  cat ~/Library/Application\ Support/Claude/claude_desktop_config.json | python -m json.tool
  ```
- 参考上面的配置示例

---

## 开发指南

### 项目结构

```
mac-control-mcp/
├── src/                      # TypeScript 源代码
│   ├── index.ts              # MCP 服务器入口点
│   ├── tools/                # 工具模块
│   │   ├── system.ts         # 系统控制工具
│   │   ├── application.ts    # 应用管理工具
│   │   └── file.ts           # 文件操作工具
│   ├── utils/                # 工具类模块
│   │   ├── applescript.ts    # AppleScript 执行器
│   │   └── shell.ts          # Shell 命令执行器
│   └── types/                # TypeScript 类型定义
│       └── index.ts
├── build/                    # 编译后的 JavaScript 输出
├── package.json              # 项目配置和依赖
├── tsconfig.json             # TypeScript 编译配置
└── README.md                 # 项目文档
```

### 构建命令

```bash
# 编译 TypeScript 到 JavaScript
npm run build

# 监听模式（开发时自动编译）
npm run dev

# 安装时自动构建
npm run prepare
```

### 添加新工具

如果你想扩展功能，添加新工具：

1. **创建或更新工具模块** 在 `src/tools/` 目录中
   ```typescript
   // src/tools/my-tool.ts
   export async function myNewTool(param: string) {
     // 实现你的功能
     return { result: "success" };
   }
   ```

2. **在 index.ts 中注册工具**
   - 在 `ListToolsRequestSchema` 处理器中添加工具描述
   - 在 `CallToolRequestSchema` 处理器中添加工具调用逻辑

3. **重新构建**
   ```bash
   npm run build
   ```

4. **重启 Claude Desktop** 测试新工具

---

## 安全特性

本 MCP 服务器包含多项安全功能：

- **命令白名单：** 只能执行已批准的 Shell 命令
- **路径清理：** 文件路径经过清理以防止注入攻击
- **错误处理：** 所有操作都包含适当的错误处理
- **无破坏性默认值：** 危险操作（强制退出、重启、关机）默认不启用

---

## 版本信息

**当前版本：** 0.1.0 (MVP - P0 功能)

**更新日志：**

### v0.1.0 (2025-10-24)
- 初始版本，包含 P0 功能
- 系统控制工具（音量、亮度、电池、系统信息）
- 应用管理工具（打开、关闭、列表、激活、隐藏）
- 文件操作工具（打开、显示、搜索、信息、废纸篓）

---

## 许可证

MIT

---

## 贡献

欢迎贡献！请随时提交 Issues 和 Pull Requests。

---

## 支持

如果遇到问题：
1. 查看本文档的 [常见问题解决](#常见问题解决) 部分
2. 查看 Claude Desktop 日志
3. 验证权限已正确授予
4. 确保 Node.js 版本为 v20 或更高

---

**配置完成！享受使用 Mac Control MCP Server 🎉**
